<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Сапер (Minesweeper)</title>
    <!-- VK Bridge -->
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-light: #f3f4f6;
            --bg-dark: #111827;
            --text-light: #1f2937;
            --text-dark: #f9fafb;
            --primary-light: #3b82f6;
            --primary-dark: #60a5fa;
            --secondary-light: #e5e7eb;
            --secondary-dark: #374151;
            --cell-light: #d1d5db;
            --cell-dark: #4b5563;
            --cell-revealed-light: #e5e7eb;
            --cell-revealed-dark: #1f2937;
            --shadow-light: rgba(0, 0, 0, 0.1);
            --shadow-dark: rgba(0, 0, 0, 0.5);
            --modal-bg-light: rgba(255, 255, 255, 0.7);
            --modal-bg-dark: rgba(17, 24, 39, 0.7);
            --accent-light: #f59e0b;
            --accent-dark: #facc15;
        }

        .dark {
            --bg-main: var(--bg-dark);
            --text-main: var(--text-dark);
            --primary: var(--primary-dark);
            --secondary: var(--secondary-dark);
            --cell-bg: var(--cell-dark);
            --cell-revealed-bg: var(--cell-revealed-dark);
            --shadow: var(--shadow-dark);
            --modal-bg: var(--modal-bg-dark);
            --accent: var(--accent-dark);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main, var(--bg-light));
            color: var(--text-main, var(--text-light));
            transition: background-color 0.3s ease, color 0.3s ease;
            overscroll-behavior: none;
        }

        .app-container {
            width: 100%;
            height: 100vh;
            height: 100dvh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            overflow: hidden;
        }

        .main-menu, .game-screen {
            max-width: 480px;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .btn {
            background-color: var(--secondary, var(--secondary-light));
            color: var(--text-main, var(--text-light));
            border-radius: 0.75rem;
            padding: 1rem;
            font-weight: 600;
            font-size: 1.125rem;
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px -1px var(--shadow, var(--shadow-light));
            border: 2px solid transparent;
        }
        .btn:hover, .btn-icon:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px var(--shadow, var(--shadow-light));
        }
        .btn-primary {
            background-color: var(--primary, var(--primary-light));
            color: white;
        }
        .btn-accent {
            background-color: var(--accent, var(--accent-light));
            color: var(--bg-dark);
        }
        .btn-icon {
             background-color: var(--secondary, var(--secondary-light));
             border-radius: 50%;
             width: 60px;
             height: 60px;
             display: flex;
             justify-content: center;
             align-items: center;
             transition: all 0.2s ease;
             box-shadow: 0 4px 6px -1px var(--shadow, var(--shadow-light));
        }
        .btn-icon img {
            width: 28px;
            height: 28px;
        }
        .btn-icon svg {
            width: 28px;
            height: 28px;
            stroke: var(--text-main, var(--text-light));
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: var(--modal-bg, var(--modal-bg-light));
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            z-index: 50;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: var(--bg-main, var(--bg-light));
            border-radius: 1.5rem;
            padding: 2rem;
            width: 100%;
            max-width: 480px;
            box-shadow: 0 25px 50px -12px var(--shadow, var(--shadow-light));
            border: 1px solid var(--secondary, var(--secondary-light));
            animation: slideInUp 0.4s ease-out;
        }

        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(30px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        #game-board {
            display: grid;
            touch-action: manipulation;
            background-color: var(--secondary, var(--secondary-light));
            padding: 0.5rem;
            border-radius: 1rem;
        }

        .cell {
            background-color: var(--cell-bg, var(--cell-light));
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 800;
            font-size: 1.25rem;
            transition: all 0.1s ease;
            cursor: pointer;
            user-select: none;
        }
        .cell.revealed {
            background-color: var(--cell-revealed-bg, var(--cell-revealed-light));
            box-shadow: inset 0 2px 4px 0 var(--shadow, var(--shadow-light));
        }
        .cell.mine {
            background-color: #ef4444;
        }

        .c-1 { color: #3b82f6; } .c-2 { color: #22c55e; }
        .c-3 { color: #ef4444; } .c-4 { color: #8b5cf6; }
        .c-5 { color: #f97316; } .c-6 { color: #14b8a6; }
        .c-7 { color: #ec4899; } .c-8 { color: #64748b; }

        .animated-svg-rule {
            animation: rule-anim 2s infinite ease-in-out;
        }
        @keyframes rule-anim {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
    </style>
</head>
<body class="antialiased overflow-hidden">
    <div id="app" class="app-container"></div>
    <audio id="bg-music" loop src="music.mp3"></audio>

    <script>
        const App = {
            // STATE MANAGEMENT
            state: {
                currentScreen: 'menu', theme: 'light',
                soundEnabled: true, musicEnabled: true,
                difficulty: null, board: [], gameStarted: false, gameOver: false,
                minesLeft: 0, time: 0, timerInterval: null,
                isLongPress: false, pressTimer: null,
                gamesPlayedSinceAd: 0,
                stats: {
                    'easy': { wins: 0, bestTime: Infinity }, 'medium': { wins: 0, bestTime: Infinity },
                    'hard': { wins: 0, bestTime: Infinity }, 'expert': { wins: 0, bestTime: Infinity },
                }
            },

            // GAME MODES (Optimized for banner ads)
            difficulties: {
                easy:   { rows: 10, cols: 8, mines: 10, name: 'Легко (10x8)' },
                medium: { rows: 15, cols: 12, mines: 30, name: 'Средне (15x12)' },
                hard:   { rows: 21, cols: 13, mines: 60, name: 'Сложно (21x13)' },
                expert: { rows: 23, cols: 14, mines: 99, name: 'Эксперт (23x14)' },
            },

            // VK INTEGRATION
            vk: {
                userId: null,
                wasMusicPlaying: false,
                async init() {
                    vkBridge.send('VKWebAppInit');
                    vkBridge.subscribe(e => {
                        if (e.detail.type === 'VKWebAppViewHide') {
                            if (!document.getElementById('bg-music').paused) {
                                this.wasMusicPlaying = true;
                                App.updateMusicState(false, true); // Force pause
                            }
                        }
                        if (e.detail.type === 'VKWebAppViewRestore') {
                            if (this.wasMusicPlaying) {
                               App.updateMusicState(true, true); // Force play
                            }
                            this.wasMusicPlaying = false;
                        }
                    });

                    try {
                        const user = await vkBridge.send('VKWebAppGetUserInfo');
                        this.userId = user.id;
                    } catch (error) {
                        console.warn("VK User ID not found, using test_user.", error);
                        this.userId = 'test_user';
                    }
                },
                showBanner() {
                    vkBridge.send('VKWebAppShowBannerAd', { banner_location: 'bottom' })
                        .catch(e => console.log("Banner Ad Error:", e));
                },
                showInterstitial() {
                    App.state.gamesPlayedSinceAd++;
                    if (App.state.gamesPlayedSinceAd >= 2) {
                        vkBridge.send('VKWebAppShowInterstitialAd').catch(e => {});
                        App.state.gamesPlayedSinceAd = 0;
                    }
                    App.saveSettings();
                }
            },
            
            sounds: {},
            initAudio() {
                this.sounds.click = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.0, release: 0.1 } }).toDestination();
                this.sounds.flag = new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.0, release: 0.1 } }).toDestination();
                this.sounds.lose = new Tone.NoiseSynth({ noise: { type: 'brown' }, envelope: { attack: 0.005, decay: 0.5, sustain: 0.1, release: 0.1 } }).toDestination();
                this.sounds.uiClick = new Tone.MembraneSynth().toDestination();

                // New, more pleasant win sound with effects
                const reverb = new Tone.Freeverb(0.7, 3000).toDestination();
                const chorus = new Tone.Chorus(4, 2.5, 0.5).connect(reverb);
                this.sounds.win = new Tone.PolySynth(Tone.Synth, {
                    oscillator: { type: 'triangle8' }, // Smoother oscillator
                    envelope: { attack: 0.05, decay: 0.4, sustain: 0.2, release: 0.8 }
                }).connect(chorus);
            },
            playSound(sound) {
                if (!this.state.soundEnabled || !this.sounds[sound]) return;
                try {
                    if (sound === 'click') this.sounds.click.triggerAttackRelease('C5', '8n');
                    if (sound === 'flag') this.sounds.flag.triggerAttackRelease('G4', '8n');
                    if (sound === 'lose') this.sounds.lose.triggerAttackRelease('16n');
                    if (sound === 'uiClick') this.sounds.uiClick.triggerAttackRelease("C2", "8n");
                    
                    // New win sound trigger (arpeggio)
                    if (sound === 'win') {
                        const now = Tone.now();
                        this.sounds.win.triggerAttackRelease('C4', '8n', now);
                        this.sounds.win.triggerAttackRelease('E4', '8n', now + 0.1);
                        this.sounds.win.triggerAttackRelease('G4', '8n', now + 0.2);
                        this.sounds.win.triggerAttackRelease('C5', '4n', now + 0.3);
                    }
                } catch (e) { console.error("Audio error:", e); }
            },

            async init() {
                await this.vk.init();
                await this.loadSettings();
                this.applyTheme();
                this.initAudio();
                this.render();

                // This listener starts audio context on first user interaction
                // It's a browser requirement to prevent autoplay abuse.
                document.body.addEventListener('click', async () => {
                    if (Tone.context.state !== 'running') {
                        await Tone.start();
                        console.log('AudioContext started!');
                    }
                    this.updateMusicState(); // Update music state on first interaction
                }, { once: true });
            },

            render() {
                const appContainer = document.getElementById('app');
                appContainer.innerHTML = '';
                this.vk.showBanner();

                switch (this.state.currentScreen) {
                    case 'menu':
                        appContainer.appendChild(this.createMainMenu());
                        break;
                    case 'game':
                        appContainer.appendChild(this.createGameScreen());
                        setTimeout(() => this.renderBoard(), 0);
                        break;
                }
            },
            
            createMainMenu() {
                const menu = document.createElement('div');
                menu.className = 'main-menu justify-center';
                menu.innerHTML = `
                    <div>
                        <div class="text-center">
                            <h1 class="text-5xl md:text-6xl font-extrabold tracking-tight">Сапер</h1>
                            <p class="text-lg opacity-70 mt-2">Классика в новом виде</p>
                        </div>
                        <div class="flex flex-col gap-4 mt-8">
                            ${Object.keys(this.difficulties).map(key => `
                                <button class="btn btn-primary difficulty-btn" data-difficulty="${key}">${this.difficulties[key].name}</button>
                            `).join('')}
                        </div>
                         <button id="other-games-btn" class="btn btn-accent w-full mt-4">Другие игры</button>
                         <div class="flex justify-center pt-8">
                            <div class="grid grid-cols-3 gap-4">
                                <button id="rules-btn" class="btn-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z" /></svg></button>
                                <button id="stats-btn" class="btn-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" /></svg></button>
                                <button id="settings-btn" class="btn-icon"><img src="settings-icon.png" alt="Настройки"></button>
                            </div>
                        </div>
                    </div>`;

                menu.querySelectorAll('.difficulty-btn').forEach(btn => {
                    btn.onclick = (e) => { this.playSound('uiClick'); this.startGame(e.target.dataset.difficulty); };
                });
                menu.querySelector('#other-games-btn').onclick = () => { this.playSound('uiClick'); this.showOtherGamesModal(); };
                menu.querySelector('#rules-btn').onclick = () => { this.playSound('uiClick'); this.showRulesModal(); };
                menu.querySelector('#stats-btn').onclick = () => { this.playSound('uiClick'); this.showStatsModal(); };
                menu.querySelector('#settings-btn').onclick = () => { this.playSound('uiClick'); this.showSettingsModal(); };
                return menu;
            },
            
            createGameScreen() { /* ... unchanged ... */ return screen; }, 
            startGame(difficultyKey) { /* ... unchanged ... */ },
            createBoard(firstClickRow, firstClickCol) { /* ... unchanged ... */ },
            renderBoard() { /* ... unchanged ... */ },
            updateBoard() { /* ... unchanged ... */ },
            handlePressStart(r, c) { /* ... unchanged ... */ },
            handlePressEnd(r, c) { /* ... unchanged ... */ },
            cancelPress() { /* ... unchanged ... */ },
            toggleFlag(r, c) { /* ... unchanged ... */ },
            revealCell(r, c) { /* ... unchanged ... */ },
            revealNeighbors(r, c) { /* ... unchanged ... */ },
            startTimer() { /* ... unchanged ... */ },
            stopTimer() { /* ... unchanged ... */ },
            checkWinCondition() { /* ... unchanged ... */ },
            
            endGame(isWin) {
                this.stopTimer();
                this.state.gameOver = true;
                this.state.board.forEach(row => row.forEach(cell => { if (cell.mine) cell.revealed = true; }));
                this.updateBoard();

                if (isWin) {
                    this.playSound('win');
                    this.updateStats();
                    this.vk.showInterstitial();
                    setTimeout(() => this.showWinLoseModal(true), 500);
                } else {
                    this.playSound('lose');
                    setTimeout(() => this.showWinLoseModal(false), 500);
                }
            },
            
            showModal(content) { /* ... unchanged ... */ },
            closeModal() { /* ... unchanged ... */ },
            
            showSettingsModal() {
                const content = `
                    <h2 class="text-3xl font-bold text-center mb-6">Настройки</h2>
                    <div class="flex flex-col gap-4">
                        <div class="flex justify-between items-center p-4 rounded-lg" style="background-color: var(--secondary, var(--secondary-light));">
                            <span class="font-semibold">Тема</span>
                            <button id="theme-toggle" class="btn text-sm px-4 py-2">${this.state.theme === 'light' ? 'Светлая ☀️' : 'Темная 🌙'}</button>
                        </div>
                        <div class="flex justify-between items-center p-4 rounded-lg" style="background-color: var(--secondary, var(--secondary-light));">
                            <span class="font-semibold">Звуки</span>
                            <button id="sound-toggle" class="btn text-sm px-4 py-2">${this.state.soundEnabled ? 'Вкл 🔊' : 'Выкл 🔇'}</button>
                        </div>
                        <div class="flex justify-between items-center p-4 rounded-lg" style="background-color: var(--secondary, var(--secondary-light));">
                            <span class="font-semibold">Музыка</span>
                            <button id="music-toggle" class="btn text-sm px-4 py-2">${this.state.musicEnabled ? 'Вкл 🎵' : 'Выкл 🔇'}</button>
                        </div>
                    </div>
                     <button id="close-modal-btn" class="btn btn-primary mt-8 w-full">Закрыть</button>`;
                this.showModal(content);
                document.getElementById('theme-toggle').onclick = () => this.toggleTheme();
                document.getElementById('sound-toggle').onclick = () => this.toggleSound();
                document.getElementById('music-toggle').onclick = () => this.toggleMusic();
                document.getElementById('close-modal-btn').onclick = () => this.closeModal();
            },
            
            showRulesModal() { /* ... unchanged ... */ },

            showStatsModal() {
                const content = `
                    <h2 class="text-3xl font-bold text-center mb-6">Статистика</h2>
                    <div class="space-y-2">
                        <div class="grid grid-cols-3 gap-2 text-center font-bold p-2 opacity-70">
                            <span>Уровень</span>
                            <span>Побед</span>
                            <span>Время</span>
                        </div>
                        ${Object.keys(this.difficulties).map(key => `
                            <div class="p-3 rounded-lg grid grid-cols-3 gap-2 items-center text-center" style="background-color: var(--secondary, var(--secondary-light));">
                               <span class="font-semibold text-left">${this.difficulties[key].name.split(' ')[0]}</span>
                               <span>${this.state.stats[key].wins}</span>
                               <span>${this.state.stats[key].bestTime !== Infinity ? this.formatTime(this.state.stats[key].bestTime) : '--:--'}</span>
                            </div>
                        `).join('')}
                    </div>
                    <button id="close-modal-btn" class="btn btn-primary mt-8 w-full">Закрыть</button>`;
                this.showModal(content);
                document.getElementById('close-modal-btn').onclick = () => this.closeModal();
            },
            
            showOtherGamesModal() {
                 const games = [
                    { name: 'Bubble Shooter', appId: 54051411, icon: 'icon1.png' }, { name: 'Тетрис', appId: 54051413, icon: 'icon2.png' },
                    { name: 'Tower Blocks', appId: 53962513, icon: 'icon3.png' }, { name: 'Блок Про', appId: 53936296, icon: 'icon4.png' },
                    { name: 'Филворды', appId: 53867134, icon: 'icon5.png' }, { name: 'Словли', appId: 53861990, icon: 'icon6.png' },
                    { name: 'Brick Balls', appId: 54023580, icon: 'icon7.png' }, { name: '2048', appId: 53965380, icon: 'icon8.png' },
                    { name: 'Math Matrix', appId: 53970659, icon: 'icon9.png' }
                ];
                const content = `
                    <h2 class="text-3xl font-bold text-center mb-6">Другие игры</h2>
                    <div class="grid grid-cols-3 gap-x-4 gap-y-6">
                    ${games.map(game => `
                        <div class="flex flex-col items-center cursor-pointer group" onclick="vkBridge.send('VKWebAppOpenApp', { app_id: ${game.appId} })">
                            <div class="w-20 h-20 bg-gray-200 dark:bg-gray-700 rounded-3xl mb-2 flex items-center justify-center group-hover:scale-105 transition-transform overflow-hidden">
                               <img src="${game.icon}" alt="${game.name}" class="w-full h-full object-cover">
                            </div>
                            <span class="text-sm font-medium text-center">${game.name}</span>
                        </div>
                    `).join('')}
                    </div>
                    <button id="close-modal-btn" class="btn btn-primary mt-8 w-full">Назад</button>`;
                this.showModal(content);
                document.getElementById('close-modal-btn').onclick = () => this.closeModal();
            },
            
            showPauseModal() { /* ... unchanged ... */ },
            showWinLoseModal(isWin) { /* ... unchanged ... */ },
            
            toggleTheme() { /* ... unchanged ... */ },
            applyTheme() { /* ... unchanged ... */ },
            toggleSound() { /* ... unchanged ... */ },
            toggleMusic() {
                this.state.musicEnabled = !this.state.musicEnabled;
                this.playSound('uiClick');
                this.updateMusicState();
                this.saveSettings();
                const musicBtn = document.getElementById('music-toggle');
                if (musicBtn) { musicBtn.innerHTML = this.state.musicEnabled ? 'Вкл 🎵' : 'Выкл 🔇'; }
            },
            updateMusicState(forceState, isFromBackground = false) {
                const music = document.getElementById('bg-music');
                let shouldPlay;
                if (typeof forceState === 'boolean') {
                    shouldPlay = forceState;
                } else {
                    shouldPlay = this.state.musicEnabled;
                }

                if (shouldPlay && (Tone.context.state === 'running' || isFromBackground)) {
                    music.play().catch(e => console.log("Music play prevented by browser."));
                } else {
                    music.pause();
                }
            },

            async saveSettings() {
                if (!this.vk.userId) return;
                const storageKey = `minesweeper_data_${this.vk.userId}`;
                const dataToSave = JSON.stringify({
                    theme: this.state.theme,
                    soundEnabled: this.state.soundEnabled,
                    musicEnabled: this.state.musicEnabled,
                    stats: this.state.stats,
                    gamesPlayedSinceAd: this.state.gamesPlayedSinceAd,
                });
                try {
                    await vkBridge.send('VKWebAppStorageSet', { key: storageKey, value: dataToSave });
                } catch (error) {
                    localStorage.setItem(storageKey, dataToSave);
                }
            },
            async loadSettings() {
                if (!this.vk.userId) return;
                const storageKey = `minesweeper_data_${this.vk.userId}`;
                let loadedData = null;
                try {
                    const response = await vkBridge.send('VKWebAppStorageGet', { keys: [storageKey] });
                    if (response.keys[0]?.value) loadedData = JSON.parse(response.keys[0].value);
                } catch (error) {
                    const localData = localStorage.getItem(storageKey);
                    if (localData) loadedData = JSON.parse(localData);
                }
                
                if (loadedData) {
                    this.state.theme = loadedData.theme || 'light';
                    this.state.soundEnabled = loadedData.soundEnabled !== false;
                    this.state.musicEnabled = loadedData.musicEnabled !== false;
                    this.state.gamesPlayedSinceAd = loadedData.gamesPlayedSinceAd || 0;
                     if(loadedData.stats) {
                        for (const key in this.state.stats) {
                           if(loadedData.stats[key]) {
                               this.state.stats[key].wins = loadedData.stats[key].wins || 0;
                               this.state.stats[key].bestTime = loadedData.stats[key].bestTime === null ? Infinity : loadedData.stats[key].bestTime || Infinity;
                           }
                        }
                    }
                }
            },

            updateStats() {
                const key = this.state.difficulty.key;
                this.state.stats[key].wins++;
                if (this.state.time < this.state.stats[key].bestTime) {
                    this.state.stats[key].bestTime = this.state.time;
                }
                this.saveSettings();
            },

            formatTime(totalSeconds) {
                if (totalSeconds === Infinity || totalSeconds === null) return '--:--';
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }
        };

        // Unchanged functions (stubs for brevity)
        App.createGameScreen = App.createGameScreen.toString().includes('...') ? function() { const screen = document.createElement('div'); screen.className = 'game-screen'; screen.innerHTML = `<div class="flex justify-between items-center p-4 rounded-xl" style="background-color: var(--secondary, var(--secondary-light));"><div class="text-center"><div class="text-sm font-bold opacity-70">ВРЕМЯ</div><div id="timer" class="text-3xl font-bold">00:00</div></div><button id="pause-btn" class="btn-icon w-14 h-14"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25v13.5m-7.5-13.5v13.5" /></svg></button><div class="text-center"><div class="text-sm font-bold opacity-70">МИНЫ</div><div id="mines-left" class="text-3xl font-bold">${this.state.minesLeft}</div></div></div><div id="game-board-container" class="flex-grow flex items-center justify-center min-h-0"><div id="game-board"></div></div>`; screen.querySelector('#pause-btn').onclick = () => { this.playSound('uiClick'); this.showPauseModal(); }; return screen; } : App.createGameScreen;
        App.startGame = App.startGame.toString().includes('...') ? function(difficultyKey) { this.state.difficulty = { key: difficultyKey, ...this.difficulties[difficultyKey] }; this.state.minesLeft = this.state.difficulty.mines; this.state.time = 0; this.state.gameStarted = false; this.state.gameOver = false; this.state.currentScreen = 'game'; this.updateMusicState(); this.render(); } : App.startGame;
        App.createBoard = App.createBoard.toString().includes('...') ? function(firstClickRow, firstClickCol) { const { rows, cols, mines } = this.state.difficulty; let board = Array(rows).fill(null).map(() => Array(cols).fill(null).map(() => ({ mine: false, revealed: false, flagged: false, adjacentMines: 0 }))); let minesPlaced = 0; while (minesPlaced < mines) { const r = Math.floor(Math.random() * rows); const c = Math.floor(Math.random() * cols); const isFirstClickArea = Math.abs(r - firstClickRow) <= 1 && Math.abs(c - firstClickCol) <= 1; if (!board[r][c].mine && !isFirstClickArea) { board[r][c].mine = true; minesPlaced++; } } for (let r = 0; r < rows; r++) { for (let c = 0; c < cols; c++) { if (board[r][c].mine) continue; let count = 0; for (let dr = -1; dr <= 1; dr++) { for (let dc = -1; dc <= 1; dc++) { if (dr === 0 && dc === 0) continue; const nr = r + dr; const nc = c + dc; if (nr >= 0 && nr < rows && nc >= 0 && nc < cols && board[nr][nc].mine) { count++; } } } board[r][c].adjacentMines = count; } } this.state.board = board; } : App.createBoard;
        App.renderBoard = App.renderBoard.toString().includes('...') ? function() { const { rows, cols } = this.state.difficulty; const boardElement = document.getElementById('game-board'); const containerElement = document.getElementById('game-board-container'); boardElement.innerHTML = ''; const containerWidth = containerElement.clientWidth; const containerHeight = containerElement.clientHeight; let cellSize = Math.floor((containerWidth - 16) / cols) - 4; const requiredBoardHeight = (cellSize + 4) * rows + 12; if (requiredBoardHeight > containerHeight) { cellSize = Math.floor((containerHeight - 16) / rows) - 4; } boardElement.style.gridTemplateColumns = `repeat(${cols}, ${cellSize}px)`; boardElement.style.gridTemplateRows = `repeat(${rows}, ${cellSize}px)`; boardElement.style.gap = '4px'; for (let r = 0; r < rows; r++) { for (let c = 0; c < cols; c++) { const cell = document.createElement('div'); cell.className = 'cell'; cell.dataset.row = r; cell.dataset.col = c; cell.style.fontSize = `${cellSize * 0.5}px`; cell.addEventListener('mousedown', (e) => { if (e.button !== 0) return; this.handlePressStart(r, c); }); cell.addEventListener('mouseup', () => this.handlePressEnd(r, c)); cell.addEventListener('mouseleave', () => this.cancelPress()); cell.addEventListener('touchstart', (e) => { e.preventDefault(); this.handlePressStart(r, c); }, { passive: false }); cell.addEventListener('touchend', (e) => { e.preventDefault(); this.handlePressEnd(r, c); }); boardElement.appendChild(cell); } } } : App.renderBoard;
        App.updateBoard = App.updateBoard.toString().includes('...') ? function() { const { rows, cols } = this.state.difficulty; for (let r = 0; r < rows; r++) { for (let c = 0; c < cols; c++) { const cellElement = document.querySelector(`.cell[data-row='${r}'][data-col='${c}']`); const cellData = this.state.board[r][c]; cellElement.innerHTML = ''; cellElement.className = 'cell'; if (cellData.flagged) { cellElement.innerHTML = '🚩'; } if (cellData.revealed) { cellElement.classList.add('revealed'); if (cellData.mine) { cellElement.innerHTML = '💣'; cellElement.classList.add('mine'); } else if (cellData.adjacentMines > 0) { cellElement.textContent = cellData.adjacentMines; cellElement.classList.add(`c-${cellData.adjacentMines}`); } } } } document.getElementById('mines-left').textContent = this.state.minesLeft; } : App.updateBoard;
        App.handlePressStart = App.handlePressStart.toString().includes('...') ? function(r,c){ if(this.state.gameOver)return; if(this.state.gameStarted&&this.state.board[r][c].revealed)return; this.state.isLongPress=!1; this.state.pressTimer=setTimeout(()=>{this.state.isLongPress=!0; this.toggleFlag(r,c)},250)} : App.handlePressStart;
        App.handlePressEnd = App.handlePressEnd.toString().includes('...') ? function(r,c){ clearTimeout(this.state.pressTimer); if(!this.state.isLongPress)this.revealCell(r,c)} : App.handlePressEnd;
        App.cancelPress = App.cancelPress.toString().includes('...') ? function(){ clearTimeout(this.state.pressTimer)} : App.cancelPress;
        App.toggleFlag = App.toggleFlag.toString().includes('...') ? function(r,c){ if(this.state.gameOver||this.state.board[r][c].revealed)return; const cell=this.state.board[r][c]; if(!cell.flagged&&this.state.minesLeft===0)return; cell.flagged=!cell.flagged; this.state.minesLeft+=cell.flagged?-1:1; this.playSound('flag'); this.updateBoard()} : App.toggleFlag;
        App.revealCell = App.revealCell.toString().includes('...') ? function(r,c){ if(this.state.gameOver)return; if(!this.state.gameStarted){ this.createBoard(r,c); this.state.gameStarted=!0; this.startTimer()} const cell=this.state.board[r][c]; if(cell.revealed||cell.flagged)return; cell.revealed=!0; this.playSound('click'); if(cell.mine)this.endGame(!1); else if(cell.adjacentMines===0)this.revealNeighbors(r,c); this.updateBoard(); this.checkWinCondition()} : App.revealCell;
        App.revealNeighbors = App.revealNeighbors.toString().includes('...') ? function(r,c){ for(let dr=-1; dr<=1; dr++)for(let dc=-1; dc<=1; dc++){ if(dr===0&&dc===0)continue; const nr=r+dr; const nc=c+dc; if(nr>=0&&nr<this.state.difficulty.rows&&nc>=0&&nc<this.state.difficulty.cols&&!this.state.board[nr][nc].revealed&&!this.state.board[nr][nc].flagged)this.revealCell(nr,nc)}} : App.revealNeighbors;
        App.startTimer = App.startTimer.toString().includes('...') ? function(){ this.stopTimer(); this.state.timerInterval=setInterval(()=>{this.state.time++; document.getElementById('timer').textContent=this.formatTime(this.state.time)},1e3)} : App.startTimer;
        App.stopTimer = App.stopTimer.toString().includes('...') ? function(){ clearInterval(this.state.timerInterval)} : App.stopTimer;
        App.checkWinCondition = App.checkWinCondition.toString().includes('...') ? function(){ const{rows,cols,mines}=this.state.difficulty; let revealedCount=0; for(let r=0; r<rows; r++)for(let c=0; c<cols; c++)if(this.state.board[r][c].revealed)revealedCount++; if(revealedCount===rows*cols-mines)this.endGame(!0)} : App.checkWinCondition;
        App.showModal = App.showModal.toString().includes('...') ? function(content) { const modal = document.createElement('div'); modal.className = 'modal-overlay'; modal.innerHTML = `<div class="modal-content">${content}</div>`; modal.onclick = (e) => { if (e.target === modal) { this.closeModal(); } }; document.body.appendChild(modal); } : App.showModal;
        App.closeModal = App.closeModal.toString().includes('...') ? function() { this.playSound('uiClick'); const modal = document.querySelector('.modal-overlay'); if (modal) { modal.style.animation = 'fadeOut 0.3s ease'; modal.firstChild.style.animation = 'slideOutDown 0.4s ease-out'; setTimeout(() => modal.remove(), 300); } } : App.closeModal;
        App.showRulesModal = App.showRulesModal.toString().includes('...') ? function() { const content = `<h2 class="text-3xl font-bold text-center mb-6">Правила Игры</h2><div class="space-y-4 text-left"><div class="flex items-center gap-4"><div class="cell revealed c-1 animated-svg-rule" style="width: 50px; height: 50px; font-size: 25px;">1</div><p class="flex-1"><span class="font-bold">Нажмите</span> на ячейку, чтобы открыть ее. Цифра показывает, сколько мин находится вокруг.</p></div><div class="flex items-center gap-4"><div class="cell animated-svg-rule" style="width: 50px; height: 50px; font-size: 25px;">🚩</div><p class="flex-1"><span class="font-bold">Удерживайте</span> ячейку, чтобы поставить или убрать флажок. Флажками отмечаются предполагаемые мины.</p></div><div class="flex items-center gap-4"><div class="cell revealed mine animated-svg-rule" style="width: 50px; height: 50px; font-size: 25px;">💣</div><p class="flex-1">Цель: открыть все ячейки, не содержащие мин. Если вы откроете мину - игра окончена.</p></div></div><button id="close-modal-btn" class="btn btn-primary mt-8 w-full">Понятно!</button>`; this.showModal(content); document.getElementById('close-modal-btn').onclick = () => this.closeModal(); } : App.showRulesModal;
        App.showPauseModal = App.showPauseModal.toString().includes('...') ? function() { this.stopTimer(); const content = `<h2 class="text-3xl font-bold text-center mb-6">Пауза</h2><div class="flex flex-col gap-4"><button id="resume-btn" class="btn btn-primary">Продолжить</button><button id="menu-btn" class="btn">В меню</button></div>`; this.showModal(content); document.getElementById('resume-btn').onclick = () => { this.closeModal(); this.startTimer(); }; document.getElementById('menu-btn').onclick = () => { this.closeModal(); this.state.currentScreen = 'menu'; this.render(); }; } : App.showPauseModal;
        App.showWinLoseModal = App.showWinLoseModal.toString().includes('...') ? function(isWin) { const title = isWin ? 'Победа! 🎉' : 'Поражение 💣'; const message = isWin ? `Отлично! Ваше время: ${this.formatTime(this.state.time)}.` : 'Упс! Кажется, вы наткнулись на мину.'; const content = `<div class="text-center"><h2 class="text-4xl font-extrabold mb-4">${title}</h2><p class="text-lg opacity-80 mb-8">${message}</p><div class="flex flex-col gap-4"><button id="play-again-btn" class="btn btn-primary">Играть снова</button><button id="menu-btn" class="btn">В меню</button></div></div>`; this.showModal(content); document.getElementById('play-again-btn').onclick = () => { this.closeModal(); this.startGame(this.state.difficulty.key); }; document.getElementById('menu-btn').onclick = () => { this.closeModal(); this.state.currentScreen = 'menu'; this.render(); }; } : App.showWinLoseModal;
        App.toggleTheme = App.toggleTheme.toString().includes('...') ? function(){ this.playSound('uiClick'); this.state.theme=this.state.theme==='light'?'dark':'light'; this.applyTheme(); this.saveSettings(); const themeBtn=document.getElementById('theme-toggle'); if(themeBtn)themeBtn.innerHTML=this.state.theme==='light'?'Светлая ☀️':'Темная 🌙'} : App.toggleTheme;
        App.applyTheme = App.applyTheme.toString().includes('...') ? function(){ if(this.state.theme==='dark')document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark')} : App.applyTheme;
        App.toggleSound = App.toggleSound.toString().includes('...') ? function(){ this.state.soundEnabled=!this.state.soundEnabled; this.playSound('uiClick'); this.saveSettings(); const soundBtn=document.getElementById('sound-toggle'); if(soundBtn)soundBtn.innerHTML=this.state.soundEnabled?'Вкл 🔊':'Выкл 🔇'} : App.toggleSound;

        // Start the application
        document.addEventListener('DOMContentLoaded', () => App.init());
        window.addEventListener('resize', () => {
            if (App.state.currentScreen === 'game') {
                App.renderBoard();
                App.updateBoard();
            }
        });
    </script>
</body>
</html>

